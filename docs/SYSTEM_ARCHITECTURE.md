# 🏗️ ECサイトシステム アーキテクチャ概要

## 🎯 システム全体像

```
🌐 インターネット
     ↓
🔒 HTTPS/SSL証明書
     ↓
⚡ Apache Webサーバー (ロリポップ)
     ↓
🐘 PHP 8.2 APIアプリケーション
     ↓
🗄️ MySQL 8.0 データベース
```

---

## 🏛️ システムアーキテクチャ

### 📱 **クライアントサイド**（将来実装）
```
📱 スマートフォン    💻 PC/タブレット
      ↓                    ↓
🌐 Next.js 15 フロントエンド
      ↓
🔗 HTTPS API通信 (JSON)
```

### ⚙️ **サーバーサイド**（完成済み）
```
🌍 Apache Webサーバー
  ↓
🛡️ セキュリティレイヤー
  - CORS チェック
  - レート制限
  - セキュリティヘッダー
  ↓
🔐 認証レイヤー
  - JWT トークン検証
  - 権限チェック
  ↓
🎯 API ルーティング
  - エンドポイント振り分け
  - バリデーション
  ↓
💼 ビジネスロジック
  - 商品管理
  - 注文処理
  - カート操作
  ↓
🗄️ データ永続化レイヤー
  - MySQL データベース
  - トランザクション管理
```

---

## 🔄 主要データフロー

### 🛒 **商品閲覧フロー**

```
👤 ユーザー
  ↓ [商品一覧を見たい]
📱 フロントエンド 
  ↓ GET /api/products
🌐 API サーバー
  ↓ [認証不要、フィルター処理]
🗄️ データベース → products テーブル
  ↓ [商品データ + カテゴリ情報]
📱 フロントエンド ← JSON レスポンス
  ↓ [商品一覧表示]
👤 ユーザー ✅
```

### 🔐 **ユーザー認証フロー**

```
👤 新規ユーザー
  ↓ [メール・パスワードで登録]
📱 フロントエンド
  ↓ POST /api/auth/register
🌐 API サーバー
  ↓ [バリデーション・パスワードハッシュ化]
🗄️ データベース → users テーブルに保存
  ↓ [ユーザー作成完了]
🔑 JWT トークン生成
  ↓ [アクセストークン + リフレッシュトークン]
📱 フロントエンド ← 認証情報
  ↓ [ローカルストレージに保存]
👤 ログイン済みユーザー ✅
```

### 🛒 **ショッピングフロー**

```
👤 ログイン済みユーザー
  ↓ [商品をカートに追加]
📱 フロントエンド
  ↓ POST /api/cart/add + JWT トークン
🌐 API サーバー
  ↓ [認証確認・在庫チェック]
🗄️ データベース → cart_items テーブル
  ↓ [カート商品追加]
📱 フロントエンド ← 更新されたカート情報
  ↓ [カート数量更新表示]
👤 ユーザー
  ↓ [注文手続きへ]
📱 フロントエンド
  ↓ POST /api/orders + 配送先情報
🌐 API サーバー
  ↓ [注文データ作成・在庫減算・カートクリア]
🗄️ データベース → orders, order_items テーブル
  ↓ [注文完了]
📧 メール通知（将来実装）
👤 注文完了 ✅
```

### 👑 **管理者管理フロー**

```
👑 管理者
  ↓ [管理画面ログイン]
📱 管理者フロントエンド
  ↓ POST /api/admin/login
🌐 API サーバー
  ↓ [管理者認証・権限確認]
🗄️ データベース → admins テーブル
  ↓ [管理者JWT発行]
📱 管理者フロントエンド ← 管理者認証情報
  ↓ [ダッシュボード表示]
👑 管理者
  ↓ [商品を追加・編集]
📱 管理者フロントエンド
  ↓ POST /api/admin/products + 商品データ
🌐 API サーバー
  ↓ [管理者権限確認・データバリデーション]
🗄️ データベース → products テーブル更新
  ↓ [商品情報更新]
📱 管理者フロントエンド ← 更新完了通知
👑 商品管理完了 ✅
```

---

## 🗄️ データベース構造

### 📊 **主要テーブル関係**

```
👥 users (ユーザー)
  ↓ 1:多
🛒 cart_items (カート商品)
  ↓ 多:1
📦 products (商品)
  ↓ 多:1
📂 categories (カテゴリ)

👥 users (ユーザー)
  ↓ 1:多
📋 orders (注文)
  ↓ 1:多
📦 order_items (注文商品)
  ↓ 多:1
📦 products (商品)

👑 admins (管理者)
  ↓ 独立した権限管理
🏪 ECサイト全体の管理
```

### 🔑 **重要なデータ項目**

#### 👤 ユーザー関連
```json
users: {
  "id": "主キー",
  "email": "ログインID", 
  "first_name": "名前",
  "last_name": "苗字",
  "password_hash": "暗号化パスワード",
  "is_active": "アカウント状態"
}
```

#### 📦 商品関連  
```json
products: {
  "id": "商品ID",
  "name": "商品名",
  "price": "価格",
  "stock_quantity": "在庫数",
  "category_id": "カテゴリID",
  "is_active": "販売状態"
}
```

#### 🛒 注文関連
```json
orders: {
  "id": "注文ID",
  "user_id": "ユーザーID", 
  "total_amount": "合計金額",
  "status": "注文ステータス",
  "shipping_address": "配送先住所"
}
```

---

## 🔒 セキュリティ層

### 🛡️ **多層防御システム**

```
🌐 インターネット
  ↓
🔐 SSL/HTTPS 暗号化
  ↓
🚫 Apache セキュリティ設定
  - 隠しファイルアクセス拒否
  - 危険なディレクトリアクセス拒否
  ↓
⚡ レート制限
  - ログイン試行制限
  - API呼び出し制限
  ↓
🎫 JWT認証
  - アクセストークン検証
  - 権限チェック
  ↓
🧹 入力サニタイゼーション
  - XSS対策
  - SQLインジェクション対策
  ↓
💼 ビジネスロジック実行
```

### 🔑 **JWT トークン管理**

```
🔐 ログイン成功
  ↓
🎫 アクセストークン (1時間有効)
  - API呼び出し用
  - ユーザー情報含む
🎫 リフレッシュトークン (7日有効)  
  - トークン更新用
  - 長期間ログイン維持
  ↓
⏰ トークン期限切れ
  ↓
🔄 自動リフレッシュ
  - フロントエンドが自動実行
  - 新しいアクセストークン発行
```

---

## ⚡ パフォーマンス最適化

### 🚀 **レスポンス高速化**

```
📱 リクエスト受信
  ↓
🔍 インデックス活用
  - データベースクエリ最適化
  - 複合インデックス使用
  ↓
📄 ページネーション
  - 大量データを分割
  - メモリ使用量削減
  ↓
🗜️ データ圧縮
  - JSON レスポンス圧縮
  - 転送量削減
  ↓
📱 高速レスポンス配信
```

### 💾 **キャッシュ戦略**（将来実装準備済み）

```
📱 API リクエスト
  ↓
🔍 Redis キャッシュ確認
  - 商品一覧などの静的データ
  ↓
💾 キャッシュヒット？
  Yes → 🚀 即座にレスポンス
  No → 🗄️ データベースアクセス
        ↓
        💾 キャッシュに保存
        ↓
        📱 レスポンス送信
```

---

## 📈 監視・ログシステム

### 📊 **ログ収集**

```
🌐 API アクセス
  ↓
📝 アクセスログ記録
  - リクエストURL
  - レスポンス時間
  - IPアドレス
  ↓
🔒 セキュリティログ記録  
  - ログイン試行
  - 権限エラー
  - 不正アクセス試行
  ↓
💾 ログファイル保存
  ↓
📊 分析・監視（将来実装）
```

### 🚨 **エラー処理フロー**

```
💥 エラー発生
  ↓
🔍 エラー分類
  - バリデーションエラー (400)
  - 認証エラー (401)  
  - 権限エラー (403)
  - リソース未発見 (404)
  - サーバーエラー (500)
  ↓
📝 エラーログ記録
  ↓
📱 統一エラーレスポンス
{
  "success": false,
  "message": "ユーザーフレンドリーなメッセージ",
  "error_code": "システム用エラーコード",
  "errors": ["詳細エラー情報"]
}
```

---

## 🔄 開発・デプロイフロー

### 🛠️ **開発環境**

```
💻 開発者PC
  ↓
🐳 Docker 開発環境
  - PHP 8.2 + Apache
  - MySQL 8.0  
  - Redis（将来用）
  - phpMyAdmin
  ↓
🧪 ローカルテスト
  ↓
📤 Git push
```

### 🚀 **本番デプロイ**

```
📤 Git Repository
  ↓
📦 本番用ビルド
  - composer install --no-dev
  - 設定ファイル本番化
  ↓
🌐 ロリポップサーバー
  - ファイルアップロード
  - データベース構築
  - SSL設定
  ↓
✅ 本番稼働開始
```

---

## 🎯 まとめ

この ECサイトシステムは：

✨ **シンプルで強力**: 必要な機能が過不足なく実装  
🔒 **高セキュリティ**: 多層防御とベストプラクティス適用  
⚡ **高パフォーマンス**: 最適化されたデータベースとキャッシュ設計  
📈 **スケーラブル**: 将来の機能追加・拡張に対応可能  
🛠️ **保守しやすい**: 明確な構造と完全なドキュメント

**完全に実用可能**な状態で、すぐにビジネスで活用できます！ 🚀